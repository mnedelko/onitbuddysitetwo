{"ast":null,"code":"\"use strict\";\n\nexports.__esModule = true;\nvar errors_1 = require(\"@ledgerhq/errors\");\nvar Tag = 0x05;\nfunction asUInt16BE(value) {\n  var b = Buffer.alloc(2);\n  b.writeUInt16BE(value, 0);\n  return b;\n}\nvar initialAcc = {\n  data: Buffer.alloc(0),\n  dataLength: 0,\n  sequence: 0\n};\n/**\n *\n */\nvar createHIDframing = function createHIDframing(channel, packetSize) {\n  return {\n    makeBlocks: function makeBlocks(apdu) {\n      var data = Buffer.concat([asUInt16BE(apdu.length), apdu]);\n      var blockSize = packetSize - 5;\n      var nbBlocks = Math.ceil(data.length / blockSize);\n      data = Buffer.concat([data, Buffer.alloc(nbBlocks * blockSize - data.length + 1).fill(0)]);\n      var blocks = [];\n      for (var i = 0; i < nbBlocks; i++) {\n        var head = Buffer.alloc(5);\n        head.writeUInt16BE(channel, 0);\n        head.writeUInt8(Tag, 2);\n        head.writeUInt16BE(i, 3);\n        var chunk = data.slice(i * blockSize, (i + 1) * blockSize);\n        blocks.push(Buffer.concat([head, chunk]));\n      }\n      return blocks;\n    },\n    reduceResponse: function reduceResponse(acc, chunk) {\n      var _a = acc || initialAcc,\n        data = _a.data,\n        dataLength = _a.dataLength,\n        sequence = _a.sequence;\n      if (chunk.readUInt16BE(0) !== channel) {\n        throw new errors_1.TransportError(\"Invalid channel\", \"InvalidChannel\");\n      }\n      if (chunk.readUInt8(2) !== Tag) {\n        throw new errors_1.TransportError(\"Invalid tag\", \"InvalidTag\");\n      }\n      if (chunk.readUInt16BE(3) !== sequence) {\n        throw new errors_1.TransportError(\"Invalid sequence\", \"InvalidSequence\");\n      }\n      if (!acc) {\n        dataLength = chunk.readUInt16BE(5);\n      }\n      sequence++;\n      var chunkData = chunk.slice(acc ? 5 : 7);\n      data = Buffer.concat([data, chunkData]);\n      if (data.length > dataLength) {\n        data = data.slice(0, dataLength);\n      }\n      return {\n        data: data,\n        dataLength: dataLength,\n        sequence: sequence\n      };\n    },\n    getReducedResult: function getReducedResult(acc) {\n      if (acc && acc.dataLength === acc.data.length) {\n        return acc.data;\n      }\n    }\n  };\n};\nexports[\"default\"] = createHIDframing;","map":{"version":3,"sources":["../src/hid-framing.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nexports.__esModule = true;\nvar errors_1 = require(\"@ledgerhq/errors\");\nvar Tag = 0x05;\nfunction asUInt16BE(value) {\n    var b = Buffer.alloc(2);\n    b.writeUInt16BE(value, 0);\n    return b;\n}\nvar initialAcc = {\n    data: Buffer.alloc(0),\n    dataLength: 0,\n    sequence: 0\n};\n/**\n *\n */\nvar createHIDframing = function (channel, packetSize) {\n    return {\n        makeBlocks: function (apdu) {\n            var data = Buffer.concat([asUInt16BE(apdu.length), apdu]);\n            var blockSize = packetSize - 5;\n            var nbBlocks = Math.ceil(data.length / blockSize);\n            data = Buffer.concat([\n                data,\n                Buffer.alloc(nbBlocks * blockSize - data.length + 1).fill(0),\n            ]);\n            var blocks = [];\n            for (var i = 0; i < nbBlocks; i++) {\n                var head = Buffer.alloc(5);\n                head.writeUInt16BE(channel, 0);\n                head.writeUInt8(Tag, 2);\n                head.writeUInt16BE(i, 3);\n                var chunk = data.slice(i * blockSize, (i + 1) * blockSize);\n                blocks.push(Buffer.concat([head, chunk]));\n            }\n            return blocks;\n        },\n        reduceResponse: function (acc, chunk) {\n            var _a = acc || initialAcc, data = _a.data, dataLength = _a.dataLength, sequence = _a.sequence;\n            if (chunk.readUInt16BE(0) !== channel) {\n                throw new errors_1.TransportError(\"Invalid channel\", \"InvalidChannel\");\n            }\n            if (chunk.readUInt8(2) !== Tag) {\n                throw new errors_1.TransportError(\"Invalid tag\", \"InvalidTag\");\n            }\n            if (chunk.readUInt16BE(3) !== sequence) {\n                throw new errors_1.TransportError(\"Invalid sequence\", \"InvalidSequence\");\n            }\n            if (!acc) {\n                dataLength = chunk.readUInt16BE(5);\n            }\n            sequence++;\n            var chunkData = chunk.slice(acc ? 5 : 7);\n            data = Buffer.concat([data, chunkData]);\n            if (data.length > dataLength) {\n                data = data.slice(0, dataLength);\n            }\n            return {\n                data: data,\n                dataLength: dataLength,\n                sequence: sequence\n            };\n        },\n        getReducedResult: function (acc) {\n            if (acc && acc.dataLength === acc.data.length) {\n                return acc.data;\n            }\n        }\n    };\n};\nexports[\"default\"] = createHIDframing;\n//# sourceMappingURL=hid-framing.js.map"]},"metadata":{},"sourceType":"script"}